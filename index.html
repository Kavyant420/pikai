<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PikuAI - Advanced AI Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Prism CSS -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism-tomorrow.css" rel="stylesheet" />

<!-- Prism JS -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-javascript.min.js"></script>
<!-- add other languages you need -->
    <style>
        * { 
    -webkit-tap-highlight-color: transparent; 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
} 

input:focus, select:focus, textarea:focus, button:focus { 
    outline: none; 
    box-shadow: none; 
    -webkit-box-shadow: none; 
}

        /* Modern Mobile-First CSS Variables */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-hover: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --border-color: #333333;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.2s ease;
            --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        }

        /* Light mode */
        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-primary);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* Mobile-First Layout */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .logo i {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            background: transparent;
            color: var(--text-secondary);
        }

        .btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-icon {
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            justify-content: center;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0 auto;
        }

        /* Messages */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .messages::-webkit-scrollbar {
            width: 4px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 100%;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
            margin-left: auto;
            max-width: 85%;
        }

        .message.assistant {
            margin-right: auto;
            max-width: 100%;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.875rem;
        }

        .avatar.user {
            background: linear-gradient(135deg, var(--accent-success), var(--accent-primary));
            color: white;
        }

        .avatar.assistant {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-bubble {
            padding: 0.875rem 1rem;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
        }

        .message.user .message-bubble {
            background: var(--accent-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            padding: 0.25rem 0.5rem;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .message-action:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Welcome Message */
        .welcome {
            text-align: center;
            padding: 2rem 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .feature {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: left;
        }

        .feature i {
            color: var(--accent-primary);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .feature h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .feature p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Typing Indicator */
        .typing {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            color: var(--text-secondary);
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Input Area */
        .input-area {
            padding: 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 0.75rem;
            gap: 0.75rem;
            transition: var(--transition);
        }

        .input-wrapper:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            font-family: var(--font-primary);
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .input-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: var(--border-radius-sm);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .input-btn.send {
            background: var(--accent-primary);
            color: white;
        }

        .input-btn.send:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .input-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Suggestions */
        .suggestions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.25rem;
        }

        .suggestions::-webkit-scrollbar {
            height: 2px;
        }

        .suggestions::-webkit-scrollbar-track {
            background: transparent;
        }

        .suggestions::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 1px;
        }

        .suggestion {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            color: var(--text-secondary);
        }

        .suggestion:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Code Blocks */
        .message-bubble pre {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 1rem;
            margin: 0.75rem 0;
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .message-bubble code {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            background: var(--bg-hover);
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            color: var(--accent-primary);
        }

        .message-bubble pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        /* Images */
        .message-image {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-sm);
            margin: 0.5rem 0;
        }

        /* Notifications */
        .notifications {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: calc(100vw - 2rem);
        }

        .notification {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        .notification.success { border-left: 4px solid var(--accent-success); }
        .notification.error { border-left: 4px solid var(--accent-error); }
        .notification.warning { border-left: 4px solid var(--accent-warning); }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            font-size: 1.25rem;
        }

        .notification-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* Sidebar for Desktop */
        .sidebar {
            display: none;
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-content {
            flex: 1;
            padding: 1rem;
        }

        .chat-history {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-item {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .chat-item:hover {
            background: var(--bg-hover);
        }

        .chat-item.active {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .chat-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 200;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .mobile-menu.open {
            left: 0;
        }

        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
.code-block {
  position: relative;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  margin: 0.75rem 0;
}

.code-block pre {
  margin: 0;
  padding: 1rem;
  overflow-x: auto;
  font-family: var(--font-mono);
  font-size: 0.875rem;
  line-height: 1.5;
}

.copy-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: var(--transition);
  color: var(--text-secondary);
}

.copy-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
        .mobile-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(300px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .main {
                flex-direction: row;
            }

            .sidebar {
                display: flex;
            }

            .chat-container {
                max-width: 800px;
            }

            .messages {
                padding: 2rem;
            }

            .input-area {
                padding: 1.5rem 2rem;
            }

            .suggestions {
                justify-content: center;
            }

            .welcome {
                padding: 4rem 2rem;
            }

            .welcome h1 {
                font-size: 2.5rem;
            }
        }

        @media (min-width: 1024px) {
            .chat-container {
                max-width: 900px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles */
        .btn:focus,
        .input:focus,
        .input-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Selection */
        ::selection {
            background: rgba(59, 130, 246, 0.3);
        }
        @keyframes fadeInQuick {
  from { opacity: 0; transform: translateY(2px); }
  to { opacity: 1; transform: translateY(0); }
}

.token {
  display: inline-block;
  opacity: 0;
  animation: fadeInQuick 0.15s ease forwards;
}
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Initializing PikuAI...</p>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-robot"></i>
                <span>PikuAI</span>
            </div>
            <button id="newChatBtn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-plus"></i>
                New Chat
            </button>
        </div>
        <div class="sidebar-content">
            <h3 style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">Recent Chats</h3>
            <div id="mobileHistory" class="chat-history"></div>
        </div>
    </div>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <button id="menuBtn" class="btn btn-icon" style="margin-right: 0.5rem;">
                    <i class="fas fa-bars"></i>
                </button>
                <i class="fas fa-robot"></i>
                <span>PikuAI</span>
            </div>
            <div class="header-actions">
                <select id="modelSelect" class="btn" style="border: 1px solid var(--border-color);">
                    <option value="openai">OpenAI GPT</option>
                    <option value="mistral">Mistral</option>
                    <option value="claude-hybridspace">Claude Hybrid</option>
                </select>
                <button id="themeBtn" class="btn btn-icon">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main class="main">
            <!-- Sidebar (Desktop) -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <button id="newChatBtnDesktop" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-plus"></i>
                        New Chat
                    </button>
                </div>
                <div class="sidebar-content">
                    <h3 style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">Recent Chats</h3>
                    <div id="chatHistory" class="chat-history"></div>
                </div>
            </aside>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Messages -->
                <div id="messages" class="messages">
                    <!-- Welcome Message -->
                    <div class="welcome">
                        <h1>Welcome to PikuAI</h1>
                        <p>I'm PikuAI, your advanced AI assistant powered by Pollinations.AI. Developed by HeadDevelopement at Pikai Research.</p>
                        
                        <div class="features">
                            <div class="feature">
                                <i class="fas fa-code"></i>
                                <h3>Code Generation</h3>
                                <p>Generate, analyze, and debug code in multiple languages</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-image"></i>
                                <h3>Image Creation</h3>
                                <p>Create stunning images from text descriptions</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-brain"></i>
                                <h3>Smart Assistance</h3>
                                <p>Get help with complex problems and creative tasks</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-edit"></i>
                                <h3>Content Writing</h3>
                                <p>Write, edit, and improve any type of content</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typing" class="typing" style="display: none;">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>PikuAI is thinking...</span>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea 
                                id="messageInput" 
                                class="input" 
                                placeholder="Message PikuAI..." 
                                rows="1"
                            ></textarea>
                            <div class="input-actions">
                                <button id="attachBtn" class="input-btn" title="Attach file">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button id="voiceBtn" class="input-btn" title="Voice input">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button id="sendBtn" class="input-btn send" title="Send message">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="suggestions">
                            <div class="suggestion" data-text="Write a Python function to sort a list">Write a Python function</div>
                            <div class="suggestion" data-text="Explain quantum computing in simple terms">Explain quantum computing</div>
                            <div class="suggestion" data-text="Create a responsive CSS layout">Create CSS layout</div>
                            <div class="suggestion" data-text="Generate an image of a futuristic city">Generate futuristic city image</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="notifications"></div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" style="display: none;" accept=".txt,.js,.html,.css,.json,.md,.py">

    <script>
        // PikuAI - Modern Mobile-First AI Platform
        class PikuAI {
            constructor() {
                this.config = {
                    apiUrl: 'https://text.pollinations.ai/',
                    imageUrl: 'https://image.pollinations.ai',
                    referrer: 'pikuai-platform',
                    maxRetries: 3,
                    retryDelay: 1000
                };

                this.state = {
                    currentChat: null,
                    chatHistory: [],
                    isTyping: false,
                    abortController: null,
                    darkMode: true,
                    mobileMenuOpen: false
                };

                this.elements = {};
                this.init();
            }

            async init() {
                this.cacheElements();
                this.setupEventListeners();
                this.loadChatHistory();
                this.setupTheme();
                
                // Show notification
                this.showNotification('Welcome to PikuAI!', 'Your advanced AI assistant is ready.', 'success');
            }

            cacheElements() {
                const ids = [
                    'loading', 'mobileOverlay', 'mobileMenu', 'menuBtn', 'newChatBtn', 'newChatBtnDesktop',
                    'themeBtn', 'modelSelect', 'messages', 'typing', 'messageInput', 'sendBtn',
                    'attachBtn', 'voiceBtn', 'chatHistory', 'mobileHistory', 'notifications', 'fileInput'
                ];

                ids.forEach(id => {
                    this.elements[id] = document.getElementById(id);
                });

                this.elements.suggestions = document.querySelectorAll('.suggestion');
            }

            setupEventListeners() {
                // Mobile menu
                this.elements.menuBtn?.addEventListener('click', () => this.toggleMobileMenu());
                this.elements.mobileOverlay?.addEventListener('click', () => this.closeMobileMenu());

                // New chat buttons
                this.elements.newChatBtn?.addEventListener('click', () => this.startNewChat());
                this.elements.newChatBtnDesktop?.addEventListener('click', () => this.startNewChat());

                // Theme toggle
                this.elements.themeBtn?.addEventListener('click', () => this.toggleTheme());

                // Message input
                this.elements.messageInput?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.elements.messageInput?.addEventListener('input', () => {
                    this.autoResizeTextarea();
                });

                // Send button
                this.elements.sendBtn?.addEventListener('click', () => this.sendMessage());

                // Suggestions
                this.elements.suggestions?.forEach(suggestion => {
                    suggestion.addEventListener('click', () => {
                        const text = suggestion.dataset.text;
                        this.elements.messageInput.value = text;
                        this.elements.messageInput.focus();
                        this.autoResizeTextarea();
                    });
                });

                // File attachment
                this.elements.attachBtn?.addEventListener('click', () => {
                    this.elements.fileInput?.click();
                });

                this.elements.fileInput?.addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });

                // Voice input
                this.elements.voiceBtn?.addEventListener('click', () => this.toggleVoiceInput());

                // Window resize
                window.addEventListener('resize', () => {
                    if (window.innerWidth >= 768) {
                        this.closeMobileMenu();
                    }
                });
            }

            toggleMobileMenu() {
                this.state.mobileMenuOpen = !this.state.mobileMenuOpen;
                
                if (this.state.mobileMenuOpen) {
                    this.elements.mobileMenu?.classList.add('open');
                    this.elements.mobileOverlay?.classList.add('open');
                    document.body.style.overflow = 'hidden';
                } else {
                    this.closeMobileMenu();
                }
            }

            closeMobileMenu() {
                this.state.mobileMenuOpen = false;
                this.elements.mobileMenu?.classList.remove('open');
                this.elements.mobileOverlay?.classList.remove('open');
                document.body.style.overflow = '';
            }

            toggleTheme() {
                this.state.darkMode = !this.state.darkMode;
                document.body.classList.toggle('light-mode', !this.state.darkMode);
                
                const icon = this.elements.themeBtn?.querySelector('i');
                if (icon) {
                    icon.className = this.state.darkMode ? 'fas fa-moon' : 'fas fa-sun';
                }

                localStorage.setItem('pikuai_theme', this.state.darkMode ? 'dark' : 'light');
            }

            setupTheme() {
                const savedTheme = localStorage.getItem('pikuai_theme');
                if (savedTheme) {
                    this.state.darkMode = savedTheme === 'dark';
                    document.body.classList.toggle('light-mode', !this.state.darkMode);
                    
                    const icon = this.elements.themeBtn?.querySelector('i');
                    if (icon) {
                        icon.className = this.state.darkMode ? 'fas fa-moon' : 'fas fa-sun';
                    }
                }
            }

            autoResizeTextarea() {
                const textarea = this.elements.messageInput;
                if (!textarea) return;

                textarea.style.height = 'auto';
                const maxHeight = 120;
                const newHeight = Math.min(textarea.scrollHeight, maxHeight);
                textarea.style.height = newHeight + 'px';
            }

            addMessage(role, content) {
    const messagesContainer = this.elements.messages;
    if (!messagesContainer) return;

    // Remove welcome message on first user input
    const welcome = messagesContainer.querySelector(".welcome");
    if (welcome && role === "user") {
        welcome.remove();
    }

    const messageElement = document.createElement("div");
    messageElement.className = `message ${role}`;

    const avatar = document.createElement("div");
    avatar.className = `avatar ${role}`;
    avatar.innerHTML = role === "user" ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

    const messageContent = document.createElement("div");
    messageContent.className = "message-content";

    const bubble = document.createElement("div");
    bubble.className = "message-bubble";

    messageContent.appendChild(bubble);
    messageElement.appendChild(avatar);
    messageElement.appendChild(messageContent);
    messagesContainer.appendChild(messageElement);

    // Animate assistant text
    if (role === "assistant") {
        this.typeWriter(content, bubble).then(() => {
            // Add copy + regenerate buttons
            const actions = document.createElement("div");
            actions.className = "message-actions";
            actions.innerHTML = `
                <button class="message-action" onclick="pikuAI.copyMessage(this)">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="message-action" onclick="pikuAI.regenerateMessage(this)">
                    <i class="fas fa-redo"></i> Regenerate
                </button>
            `;
            messageContent.appendChild(actions);
        });
    } else {
    // User messages â†’ instant
    bubble.innerHTML = this.processContent(content);
    
    // ADD THIS LINE HERE TOO:
    Prism.highlightAllUnder(bubble);
}

    this.scrollToBottom();

    // Save chat state
    if (!this.state.currentChat) {
        this.state.currentChat = {
            id: this.generateId(),
            title: content.slice(0, 50) + (content.length > 50 ? "..." : ""),
            messages: [],
            timestamp: Date.now()
        };
    }

    this.state.currentChat.messages.push({
        role,
        content,
        timestamp: Date.now()
    });

    return messageElement;
}
async sendMessage() {
    const input = this.elements.messageInput?.value?.trim();
    if (!input && (!this.state.attachments || this.state.attachments.length === 0)) return;

    try {
        // Add user message (with optional attachment notice)
        if (input) this.addMessage("user", input);
        if (this.state.attachments?.length) {
            this.state.attachments.forEach(file => {
                this.addMessage("user", `ðŸ“Ž ${file.name}`);
            });
        }

        // Clear input + attachments
        this.elements.messageInput.value = "";
        this.state.attachments = [];
        this.autoResizeTextarea();

        // Show typing
        this.showTyping(true);

        // Prepare messages
        const messages = this.prepareMessages(input);

        // Call API
        const response = await this.callAPI(messages);

        // Show AI response
        this.addMessage("assistant", response, { raw: true });

        this.saveCurrentChat();
    } catch (err) {
        console.error("Error sending:", err);
        this.addMessage("assistant", "âŒ Error sending message.");
    } finally {
        this.showTyping(false);
    }
}
            prepareMessages(input) {
    const messages = [
        {
            role: "system",
            content: `You are PikuAI, an advanced AI assistant developed by HeadDevelopement at Pikai Research. You are powered by Pollinations.AI and specialize in:

- Code generation, analysis, and debugging
- Creative problem solving and content creation
- Image generation guidance and descriptions
- Technical explanations and tutorials
- General assistance and conversation

Key traits:
- Professional yet friendly
- Provide practical, actionable solutions
- Always identify yourself as PikuAI when asked
- Be concise but thorough
- Use markdown formatting for code blocks
- When asked to generate images, provide detailed descriptions for the Pollinations.AI image API`
        }
    ];

    // Add last 10 messages (excluding system)
    if (this.state.currentChat?.messages) {
        const history = this.state.currentChat.messages.slice(-1);
        history.forEach(msg => {
            if (msg.role === "user" || msg.role === "assistant") {
                messages.push({ role: msg.role, content: msg.content });
            }
        });
    }

    // Add new user message
    if (input) {
        messages.push({ role: "user", content: input });
    }

    return messages;
}

            async callAPI(messages) {
    const response = await fetch("https://text.pollinations.ai/openai", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ messages }),
        signal: this.state.abortController?.signal
    });

    if (!response.ok) {
        throw new Error(`API request failed: ${response.status}`);
    }

    const data = await response.json();

    // Pollinations usually returns OpenAI-like format
    return data.choices?.[0]?.message?.content 
        || data.content
        || "I apologize, but I could not generate a response.";
}
            addMessage(role, content) {
    const messagesContainer = this.elements.messages;
    if (!messagesContainer) return;

    // Remove welcome on first user input
    const welcome = messagesContainer.querySelector(".welcome");
    if (welcome && role === "user") welcome.remove();

    const messageElement = document.createElement("div");
    messageElement.className = `message ${role}`;

    const avatar = document.createElement("div");
    avatar.className = `avatar ${role}`;
    avatar.innerHTML = role === "user" ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

    const messageContent = document.createElement("div");
    messageContent.className = "message-content";

    const bubble = document.createElement("div");
    bubble.className = "message-bubble";

    // If assistant AND message contains a fenced code block, insert directly (no typewriter).
    const containsFencedCode = /```/.test(content);

    if (role === "assistant" && !containsFencedCode && typeof this.typeWriter === "function") {
        // Use existing typeWriter to animate text into the bubble (if you want)
        messageContent.appendChild(bubble);
        messageElement.appendChild(avatar);
        messageElement.appendChild(messageContent);
        messagesContainer.appendChild(messageElement);

        // Typewriter should insert plain text (or HTML if your typeWriter supports it).
        // If your typeWriter produces HTML, ensure it doesn't convert newlines into <br> inside code blocks.
        this.typeWriter(content, bubble).then(() => {
            const actions = document.createElement("div");
            actions.className = "message-actions";
            actions.innerHTML = `
                <button class="message-action" onclick="pikuAI.copyMessage(this)">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="message-action" onclick="pikuAI.regenerateMessage(this)">
                    <i class="fas fa-redo"></i> Regenerate
                </button>
            `;
            messageContent.appendChild(actions);

            // Highlight any code that may have been inserted by the typeWriter
            bubble.querySelectorAll("pre code").forEach(el => {
                if (window.Prism) Prism.highlightElement(el);
            });
            this.scrollToBottom();
        });
    } else {
        // Normal path (user messages or assistant messages with code)
        bubble.innerHTML = this.processContent(content);
        messageContent.appendChild(bubble);

      if (role === "assistant") {
    // Animate character by character
    this.typeWriter(this.processContent(content), bubble, 1).then(() => {
        const actions = document.createElement("div");
        actions.className = "message-actions";
        actions.innerHTML = `
            <button class="message-action" onclick="pikuAI.copyMessage(this)">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="message-action" onclick="pikuAI.regenerateMessage(this)">
                <i class="fas fa-redo"></i> Regenerate
            </button>
        `;
        messageContent.appendChild(actions);
    });
} else {
    // User messages â†’ instant
    bubble.innerHTML = this.processContent(content);
    Prism.highlightAllUnder(bubble);
}

        messageElement.appendChild(avatar);
        messageElement.appendChild(messageContent);
        messagesContainer.appendChild(messageElement);

        // **Highlight code AFTER appending to DOM**
        bubble.querySelectorAll("pre code").forEach(el => {
            if (window.Prism && typeof Prism.highlightElement === "function") {
                Prism.highlightElement(el);
            }
        });

        this.scrollToBottom();
    }

    // Save chat state (same logic you had)
    if (!this.state.currentChat) {
        this.state.currentChat = {
            id: this.generateId(),
            title: content.slice(0, 50) + (content.length > 50 ? "..." : ""),
            messages: [],
            timestamp: Date.now()
        };
    }

    this.state.currentChat.messages.push({
        role,
        content,
        timestamp: Date.now()
    });

    return messageElement;
}
async typeWriter(content, bubble, speed = 1) {
    return new Promise((resolve) => {
        let i = 0;
        bubble.innerHTML = "";

        const interval = setInterval(() => {
            bubble.innerHTML += content[i];
            i++;

            // scroll down as it types
            this.scrollToBottom();

            if (i >= content.length) {
                clearInterval(interval);

                // after typing finishes, highlight code
                bubble.querySelectorAll("pre code").forEach(el => {
                    if (window.Prism) Prism.highlightElement(el);
                });

                resolve();
            }
        }, speed); // 1ms per char
    });
}
            processContent(content) {
    if (!content) return "";

    // 1) Extract fenced code blocks and replace with placeholders
    const codeBlocks = [];
    content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        const idx = codeBlocks.push({ lang: lang || "text", code }) - 1;
        return `@@CODE_BLOCK_${idx}@@`;
    });

    // 2) Inline code `like this` (escape HTML inside)
    content = content.replace(/`([^`]+)`/g, (m, code) => {
        return `<code>${this.escapeHtml(code)}</code>`;
    });

    // 3) URLs -> links or images (ignore placeholders as they don't look like urls)
    content = content.replace(/https?:\/\/[^\s<]+/g, (url) => {
        if (/\.(jpe?g|png|gif|webp|svg)$/i.test(url) || url.includes("image.pollinations.ai")) {
            return `<img src="${url}" alt="Generated image" class="message-image" loading="lazy">`;
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });

    // 4) Convert remaining newlines to <br> (safe: code blocks are placeholders so they won't be affected)
    content = content.replace(/\n/g, "<br>");

    // 5) Restore code blocks (with original newlines preserved) and give them unique IDs for copy buttons
    content = content.replace(/@@CODE_BLOCK_(\d+)@@/g, (m, idx) => {
        const cb = codeBlocks[Number(idx)];
        if (!cb) return "";
        const id = "code-" + Math.random().toString(36).slice(2, 9);
        return `
            <div class="code-block">
                <button class="copy-btn" onclick="pikuAI.copyCode('${id}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <pre><code id="${id}" class="language-${cb.lang}">${this.escapeHtml(cb.code)}</code></pre>
            </div>
        `;
    });

    return content;
}
copyCode(id) {
    const codeElement = document.getElementById(id);
    if (!codeElement) return;

    const text = codeElement.innerText;
    navigator.clipboard.writeText(text).then(() => {
        this.showNotification("Copied!", "Code copied to clipboard", "success");
    }).catch(() => {
        this.showNotification("Error", "Failed to copy code", "error");
    });
}
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showTyping(show) {
                this.state.isTyping = show;
                const typing = this.elements.typing;
                if (typing) {
                    typing.style.display = show ? 'flex' : 'none';
                    if (show) {
                        this.scrollToBottom();
                    }
                }

                // Update send button
                if (this.elements.sendBtn) {
                    this.elements.sendBtn.disabled = show;
                }
            }

            scrollToBottom() {
                const messages = this.elements.messages;
                if (messages) {
                    messages.scrollTop = messages.scrollHeight;
                }
            }

            startNewChat() {
                // Save current chat
                if (this.state.currentChat) {
                    this.saveCurrentChat();
                }

                // Clear current chat
                this.state.currentChat = null;

                // Clear messages and show welcome
                if (this.elements.messages) {
                    this.elements.messages.innerHTML = `
                        <div class="welcome">
                            <h1>Welcome to PikuAI</h1>
                            <p>I'm PikuAI, your advanced AI assistant powered by Pollinations.AI. Developed by HeadDevelopement at Pikai Research.</p>
                            
                            <div class="features">
                                <div class="feature">
                                    <i class="fas fa-code"></i>
                                    <h3>Code Generation</h3>
                                    <p>Generate, analyze, and debug code in multiple languages</p>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-image"></i>
                                    <h3>Image Creation</h3>
                                    <p>Create stunning images from text descriptions</p>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-brain"></i>
                                    <h3>Smart Assistance</h3>
                                    <p>Get help with complex problems and creative tasks</p>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-edit"></i>
                                    <h3>Content Writing</h3>
                                    <p>Write, edit, and improve any type of content</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Close mobile menu
                this.closeMobileMenu();

                // Focus input
                this.elements.messageInput?.focus();

                this.showNotification('New Chat', 'Started a new conversation', 'success');
            }

            copyMessage(button) {
                const bubble = button.closest('.message-content').querySelector('.message-bubble');
                const text = bubble.textContent;
                
                navigator.clipboard.writeText(text).then(() => {
                    this.showNotification('Copied!', 'Message copied to clipboard', 'success');
                }).catch(() => {
                    this.showNotification('Error', 'Failed to copy message', 'error');
                });
            }

            async regenerateMessage(button) {
                const messageElement = button.closest('.message');
                const userMessages = this.state.currentChat?.messages?.filter(m => m.role === 'user') || [];
                
                if (userMessages.length > 0) {
                    const lastUserMessage = userMessages[userMessages.length - 1];
                    
                    // Remove the assistant message
                    messageElement.remove();
                    
                    // Remove from chat history
                    if (this.state.currentChat?.messages) {
                        this.state.currentChat.messages = this.state.currentChat.messages.slice(0, -1);
                    }
                    
                    // Resend the last user message
                    this.elements.messageInput.value = lastUserMessage.content;
                    await this.sendMessage();
                }
            }

            handleFileUpload(file) {
    if (!file) return;

    // Store in state
    if (!this.state.attachments) this.state.attachments = [];
    this.state.attachments.push(file);

    // Show a "file attached" bubble instead of pasting text
    this.addMessage("user", `ðŸ“Ž Attached file: <strong>${file.name}</strong>`);

    this.showNotification('File Attached', `${file.name} has been attached`, 'success');
}

            toggleVoiceInput() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showNotification('Not Supported', 'Speech recognition is not supported in this browser', 'warning');
                    return;
                }

                if (this.recognition && this.recognition.isListening) {
                    this.stopVoiceInput();
                } else {
                    this.startVoiceInput();
                }
            }

            startVoiceInput() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-US';
                this.recognition.isListening = true;

                this.recognition.onstart = () => {
                    this.elements.voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    this.elements.voiceBtn.style.background = 'var(--accent-error)';
                    this.showNotification('Listening...', 'Speak now', 'success');
                };

                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.elements.messageInput.value = transcript;
                    this.autoResizeTextarea();
                    this.elements.messageInput.focus();
                };

                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.showNotification('Voice Error', 'Speech recognition failed', 'error');
                    this.stopVoiceInput();
                };

                this.recognition.onend = () => {
                    this.stopVoiceInput();
                };

                this.recognition.start();
            }

            stopVoiceInput() {
                if (this.recognition) {
                    this.recognition.isListening = false;
                    this.recognition.stop();
                }
                
                this.elements.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                this.elements.voiceBtn.style.background = '';
            }

            saveCurrentChat() {
                if (!this.state.currentChat) return;

                const existingIndex = this.state.chatHistory.findIndex(chat => chat.id === this.state.currentChat.id);
                
                if (existingIndex !== -1) {
                    this.state.chatHistory[existingIndex] = { ...this.state.currentChat };
                } else {
                    this.state.chatHistory.unshift({ ...this.state.currentChat });
                }

                // Limit to 50 chats
                this.state.chatHistory = this.state.chatHistory.slice(0, 50);

                localStorage.setItem('pikuai_chats', JSON.stringify(this.state.chatHistory));
                this.updateChatHistory();
            }

            loadChatHistory() {
                try {
                    const saved = localStorage.getItem('pikuai_chats');
                    this.state.chatHistory = saved ? JSON.parse(saved) : [];
                    this.updateChatHistory();
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                }
            }

            updateChatHistory() {
                const containers = [this.elements.chatHistory, this.elements.mobileHistory];
                
                containers.forEach(container => {
                    if (!container) return;

                    if (this.state.chatHistory.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No chat history</p>';
                        return;
                    }

                    container.innerHTML = this.state.chatHistory.map(chat => `
                        <div class="chat-item ${chat.id === this.state.currentChat?.id ? 'active' : ''}" 
                             onclick="pikuAI.loadChat('${chat.id}')">
                            <div class="chat-title">${chat.title}</div>
                            <div class="chat-preview">${new Date(chat.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                });
            }

            loadChat(chatId) {
                const chat = this.state.chatHistory.find(c => c.id === chatId);
                if (!chat) return;

                // Save current chat
                if (this.state.currentChat) {
                    this.saveCurrentChat();
                }

                // Load chat
                this.state.currentChat = { ...chat };

                // Clear messages and rebuild
                if (this.elements.messages) {
                    this.elements.messages.innerHTML = '';
                    
                    chat.messages.forEach(msg => {
                        this.addMessage(msg.role, msg.content);
                    });
                }

                this.updateChatHistory();
                this.closeMobileMenu();
                this.showNotification('Chat Loaded', 'Previous conversation loaded', 'success');
            }

            showNotification(title, message, type = 'success') {
                const container = this.elements.notifications;
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">${title}</div>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                    <div class="notification-message">${message}</div>
                `;

                container.appendChild(notification);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
        }

        // Initialize PikuAI
        const pikuAI = new PikuAI();
        window.pikuAI = pikuAI;
     
    </script>
</body>
  </html>
